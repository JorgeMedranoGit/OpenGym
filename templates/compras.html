<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
{% extends "base.html" %}
{% block title %}Compras{% endblock %}
{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
{% for msg in messages %}
<p class="btn btn-primary">{{msg}}</p>
{% endfor%}
{% endif %}
{% endwith %}

<style>
  .cards-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 columnas iguales */
    gap: 0px; /* Espacio entre las tarjetas */
    margin: 0;
    margin-top: 50px;
    width: 60%;
  }

  .container {
    position: relative;
    width: 250px;
    height: 80px;
    border: 1px black solid;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    background-color: white;
    padding: 30px 10px 10px 10px;
    box-sizing: border-box;
  }

  .red-box {
    position: absolute;
    top: -20px;
    left: 10px;
    width: 120px;
    height: 30px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    border: 2px black solid;
  }

  /* Media query para pantallas pequeñas */
  @media (max-width: 768px) {
    .cards-container {
      grid-template-columns: 1fr; /* 1 columna en pantallas pequeñas */
    }
    .container{
      margin-bottom: 30px;
    }
  }
</style>

<h3>Gestion de compras</h3>

<a class="btn btn-success mt-2" href="/compras/agregar">Registrar compra</a>

<div class="cards-container">
  {% if rol == "Administrador" %}
  <div class="container">
      <div class="red-box" style="background-color: red;"></div>
      <p>Total de ventas: {{ total_compras }} bs.</p>
  </div>
  {% endif %}
  
  <div class="container">
      <div class="red-box" style="background-color: #ffca47;"></div>
      <p>Tus ventas: {{ total_compras_individual }} bs.</p>
  </div>
  
  <div class="container">
      <div class="red-box" style="background-color: #00da77;"></div>
      <p>Mas vendido: {{ producto_mas_comprado.nombre }} ({{producto_mas_comprado.total_compras}} u.)</p>
  </div>
</div>



<div class="custom-grid-container">
  {% for compra in compras %}
  <div class="custom-card" data-id="{{compra.idcompra}}">
      <div class="custom-card-summary">
          <strong>Fecha:&nbsp;</strong>{{compra.fechacompra}}
          <strong>&nbsp;Hora:&nbsp;</strong>{{ compra.horacompra }}
          <strong>&nbsp;Total:&nbsp;</strong>{{ compra.total }}
          <p><strong>Empleado:</strong>&nbsp;{{compra.nombreempleado}}</p>
          <p><strong>Cliente:</strong>&nbsp;{{compra.nombrecliente}}</p>
          <p><strong>Método de pago:</strong>&nbsp;{{compra.metodopago}}</p>
          <h5><strong>Productos</strong> <i class="fas fa-angle-down"></i></h5>
      </div>
      <div class="custom-card-details" id="details-{{ compra.idcompra }}" style="display: none;"></div>
  </div>
  {% endfor %}
</div>



<script>
  document.addEventListener("DOMContentLoaded", function() {
    const tarjetas = document.querySelectorAll('.custom-card');

    tarjetas.forEach(tarjeta => {
      tarjeta.addEventListener('click', function() {
        const idcompra = this.dataset.id; 
        const detailsDiv = document.getElementById(`details-${idcompra}`); 

        if (detailsDiv.style.display === "none" || detailsDiv.style.display === "") {
          detailsDiv.style.display = "block";

          fetch(`/compras/detallecompras/${idcompra}`)
            .then(response => {
              if (!response.ok) {
                throw new Error("Error al obtener los datos");
              }
              return response.json();
            })
            .then(data => {
              if (!data.resultados || !Array.isArray(data.resultados)) {
                throw new Error("Datos inválidos recibidos");
              }

              const detallesHtml = data.resultados.map(detalle => `
                            <p><strong>Producto:</strong> ${detalle.producto}</p>
                            <p><strong>Cantidad:</strong> ${detalle.cantidad}</p>
                            <p><strong>Subtotal:</strong> ${detalle.subtotal}</p>
                            <hr>
                        `).join('');
              detailsDiv.innerHTML = detallesHtml;
            })
            .catch(error => {
              console.error("Hubo un problema con la solicitud:", error);
              detailsDiv.innerHTML = `<p>Error al cargar los detalles.</p>`;
            });
        } else {
          detailsDiv.style.display = "none";
        }
      });
    });
  });




  
</script>


  
{% endblock %}